<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Vi√°ticos</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f9fafb;padding:20px;line-height:1.5;}
        .container{max-width:1200px;margin:0 auto;}
        h1{color:#1f2937;font-size:2em;margin-bottom:20px;}
        .nav-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:30px;}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all .3s;display:inline-flex;align-items:center;gap:8px;}
        .btn-sm{padding:5px 10px;font-size:12px;border-radius:6px;}
        .btn-icon{padding:6px 10px;font-size:13px;line-height:1;}
        .btn-primary{background:#2563eb;color:#fff;} .btn-primary:hover{background:#1d4ed8;}
        .btn-secondary{background:#fff;color:#374151;border:1px solid #d1d5db;} .btn-secondary:hover{background:#f3f4f6;}
        .btn-success{background:#16a34a;color:#fff;} .btn-success:hover{background:#15803d;}
        .btn-danger{background:#dc2626;color:#fff;} .btn-danger:hover{background:#b91c1c;}
        .btn-warning{background:#d97706;color:#fff;} .btn-warning:hover{background:#b45309;}
        .btn-purple{background:#9333ea;color:#fff;} .btn-purple:hover{background:#7e22ce;}
        .card{background:#fff;border-radius:12px;padding:24px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
        .card h2{color:#1f2937;font-size:1.25em;margin-bottom:16px;}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;}
        .form-group{display:flex;flex-direction:column;}
        label{font-size:14px;font-weight:500;color:#374151;margin-bottom:6px;}
        input[type=text],input[type=number]{padding:9px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;transition:all .3s;}
        input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1);}
        .evento-card{border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:20px;background:#fff;}
        .evento-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
        .evento-header h3{color:#1f2937;font-size:1.1em;}
        .gastos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:12px;}
        .gastos-grid label{font-size:12px;color:#6b7280;}
        .gastos-grid input{font-size:13px;padding:6px 10px;}
        .resumen-box{background:#f9fafb;padding:14px;border-radius:8px;margin-top:14px;}
        .resumen-item{display:flex;justify-content:space-between;padding:7px 12px;background:#fff;border-radius:4px;margin-bottom:5px;}
        .resumen-item.total{border-top:2px solid #2563eb;padding-top:10px;margin-top:6px;font-weight:bold;background:#eff6ff;}
        .summary-card{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;padding:24px;border-radius:12px;margin-bottom:20px;}
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-top:16px;}
        .summary-item{background:rgba(255,255,255,.2);padding:16px;border-radius:8px;}
        .summary-item p{font-size:14px;opacity:.9;margin-bottom:6px;}
        .summary-item h3{font-size:22px;font-weight:bold;}
        .deficit{border:2px solid rgba(239,68,68,.3);}
        .historial-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;}
        .historial-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .3s;}
        .historial-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.15);}
        .historial-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
        .historial-header-title h3{font-size:14px;color:#1f2937;margin-bottom:2px;}
        .historial-header-title p{font-size:12px;color:#6b7280;}
        .historial-info{font-size:14px;color:#6b7280;margin-bottom:6px;}
        .historial-actions{display:flex;gap:8px;margin-top:14px;}
        .historial-actions .btn{flex:1;justify-content:center;padding:8px 10px;font-size:13px;}
        .edit-banner{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
        .edit-banner span{font-size:14px;color:#92400e;font-weight:500;}
        .edit-banner-actions{display:flex;gap:8px;flex-shrink:0;}
        .empty-state{text-align:center;padding:60px 20px;color:#9ca3af;}
        .empty-state-icon{font-size:64px;margin-bottom:16px;}
        .iva-nota{font-size:11px;color:#6b7280;margin-top:4px;font-style:italic;}
        .hidden{display:none;}

        /* REPORTE */
        #informe-content{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;color:#111;}
        .rpt-wrap{background:#fff;padding:16px 20px;}
        .rpt-header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #111;padding-bottom:8px;margin-bottom:10px;}
        .rpt-title{font-size:14px;font-weight:bold;text-transform:uppercase;letter-spacing:.5px;color:#111;}
        .rpt-sub{font-size:9px;color:#444;margin-top:2px;}
        .rpt-meta{display:grid;grid-template-columns:repeat(4,auto);gap:4px 20px;text-align:right;}
        .rpt-meta-item p:first-child{font-size:8px;color:#555;text-transform:uppercase;}
        .rpt-meta-item p:last-child{font-weight:bold;font-size:9px;color:#111;}
        .rpt-resumen{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;}
        .rpt-res-item{border:1.5px solid #888;border-radius:4px;padding:6px 10px;text-align:center;background:#f0f0f0;}
        .rpt-res-item .rlabel{font-size:8px;color:#444;text-transform:uppercase;margin-bottom:2px;}
        .rpt-res-item .rval{font-size:13px;font-weight:bold;color:#111;}
        .rpt-table{width:100%;border-collapse:collapse;margin-bottom:8px;}
        .rpt-table th{background:#222;color:#fff;padding:4px 6px;font-size:8px;text-transform:uppercase;font-weight:700;}
        .rpt-table td{padding:3px 6px;border-bottom:1px solid #bbb;font-size:9px;color:#111;}
        .rpt-table tr.fila-par td{background:#ebebeb;}
        .rpt-table .ev-header td{background:#555;color:#fff;font-weight:bold;font-size:9px;padding:4px 6px;}
        .rpt-table .ev-subtotal td{background:#d0d0d0;font-weight:bold;font-size:9px;color:#111;border-top:1px solid #888;}
        .rpt-table .grand-total td{background:#111;color:#fff;font-weight:bold;font-size:10px;padding:5px 6px;}
        .rpt-consolidado{margin-top:8px;border:1px solid #999;border-radius:4px;overflow:hidden;}
        .rpt-consolidado-title{background:#444;color:#fff;padding:4px 8px;font-size:9px;font-weight:bold;text-transform:uppercase;}
        .rpt-consolidado-grid{display:grid;grid-template-columns:repeat(7,1fr);}
        .rpt-con-item{padding:6px 4px;text-align:center;border-right:1px solid #ccc;}
        .rpt-con-item:last-child{border-right:none;}
        .rpt-con-item .clabel{font-size:8px;color:#444;font-weight:700;text-transform:uppercase;margin-bottom:2px;}
        .rpt-con-item .cval{font-size:10px;font-weight:bold;color:#111;}
        .rpt-con-item .civa{font-size:7px;color:#555;}
        .rpt-firmas{display:flex;justify-content:flex-start;margin-top:14px;padding-top:10px;border-top:1px solid #888;}
        .rpt-firma{text-align:center;width:220px;}
        .rpt-firma-line{border-top:1px solid #222;margin-bottom:4px;margin-top:24px;width:100%;}
        .rpt-firma p{font-size:8px;color:#222;}

        @media print{
            @page{margin:.8cm;size:letter portrait;}
            body{background:#fff;padding:0;}
            .no-print{display:none!important;}
            .card{box-shadow:none;padding:0;margin:0;}
            .container{max-width:100%;}
            #informe-content{font-size:10px;}
            .rpt-wrap{padding:0;}
            /* Forzar impresi√≥n de fondos y colores */
            *{
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
        @media(max-width:768px){
            body{padding:10px;}
            .form-grid,.gastos-grid,.summary-grid{grid-template-columns:1fr;}
            h1{font-size:1.5em;}
            .nav-buttons{flex-direction:column;}
            .btn{width:100%;justify-content:center;}
            .historial-grid{grid-template-columns:1fr;}
            .rpt-meta{grid-template-columns:repeat(2,auto);text-align:left;}
            .rpt-consolidado-grid{grid-template-columns:repeat(3,1fr);}
            .edit-banner{flex-direction:column;align-items:flex-start;}
        }
    </style>
</head>
<body>
<div class="container">
    <div class="no-print">
        <h1>Sistema de Gesti√≥n de Vi√°ticos</h1>
        <div class="nav-buttons">
            <button class="btn btn-primary" onclick="mostrarVista('registro')">üìù Registro</button>
            <button class="btn btn-secondary" onclick="mostrarVista('informe')">üìÑ Informe Actual</button>
            <button class="btn btn-secondary" onclick="mostrarVista('historial')">üì¶ Historial (<span id="historial-count">0</span>)</button>
        </div>
    </div>

    <!-- Registro -->
    <div id="vista-registro">
        <div id="edit-banner" class="edit-banner hidden">
            <span>‚úèÔ∏è Editando: <strong id="edit-banner-nombre"></strong></span>
            <div class="edit-banner-actions">
                <button class="btn btn-success btn-sm" onclick="guardarEdicion()">üíæ Guardar cambios</button>
                <button class="btn btn-secondary btn-sm" onclick="cancelarEdicion()">‚úï Cancelar</button>
            </div>
        </div>
        <div class="card">
            <h2>Informaci√≥n General</h2>
            <div class="form-grid">
                <div class="form-group"><label>Nombre del L√≠der</label><input type="text" id="lider" placeholder="Ingrese nombre"></div>
                <div class="form-group"><label>N√∫mero de Semana</label><input type="text" id="semana" placeholder="Ej: 42"></div>
                <div class="form-group"><label>N√∫mero de Cuarto</label><input type="text" id="cuarto" placeholder="Ej: 201"></div>
            </div>
        </div>
        <button class="btn btn-success" onclick="agregarEvento()" style="width:100%;margin-bottom:20px;">‚ûï Agregar Evento</button>
        <div id="eventos-container"></div>
        <div id="resumen-semanal" class="hidden">
            <div class="summary-card">
                <h2 style="color:#fff;">Resumen Semanal</h2>
                <div class="summary-grid">
                    <div class="summary-item"><p>Total Vi√°ticos Asignados</p><h3 id="total-viaticos-asignados">$0.00</h3></div>
                    <div class="summary-item"><p>Total Gastado</p><h3 id="total-gastado">$0.00</h3></div>
                    <div class="summary-item" id="diferencia-card"><p id="diferencia-label">Saldo</p><h3 id="diferencia-total">$0.00</h3></div>
                </div>
            </div>
            <button class="btn btn-purple" onclick="guardarInforme()" style="width:100%;">üíæ Guardar Informe</button>
        </div>
    </div>

    <!-- Historial -->
    <div id="vista-historial" class="hidden">
        <h2 style="margin-bottom:24px;">Historial de Informes</h2>
        <div id="historial-container"></div>
    </div>

    <!-- Informe -->
    <div id="vista-informe" class="hidden">
        <div class="no-print" style="margin-bottom:16px;text-align:right;">
            <button class="btn btn-primary" onclick="imprimirInforme()">üñ®Ô∏è Imprimir / Guardar PDF</button>
        </div>
        <div id="informe-content"></div>
    </div>
</div>

<script>
var CATEGORIAS = ['HOTEL','ALIMENTOS','GASOLINA','PAPELERIA','RECARGA','UBER','PARQUEO'];
var CATS_IVA   = ['GASOLINA','HOTEL'];
var IVA        = 0.13;

var eventos          = [];
var informesGuardados = [];
var informeSeleccionado = null;
var modoEdicion      = false;
var idInformeEditando = null;

actualizarContadorHistorial();

/* ‚îÄ‚îÄ helpers ‚îÄ‚îÄ */
function extraerIVA(m){ var base = m/(1+IVA); return {base:base, iva:m-base}; }

function calcularTotal(g){
    var s=0; for(var k in g) s+=g[k]; return s;
}

function calcularIVADesglosado(g){
    var s=0;
    for(var i=0;i<CATS_IVA.length;i++){
        var c=CATS_IVA[i]; if(g[c]) s+=extraerIVA(g[c]).iva;
    }
    return s;
}

function nombreInforme(info){
    return 'Liquidaci\u00f3n Semana '+(info.semana||'?')+' Cuarto '+(info.cuarto||'?');
}

function fmt(n){ return '$'+n.toFixed(2); }

/* ‚îÄ‚îÄ vistas ‚îÄ‚îÄ */
function mostrarVista(v){
    var vistas=['registro','historial','informe'];
    for(var i=0;i<vistas.length;i++) document.getElementById('vista-'+vistas[i]).classList.add('hidden');
    document.getElementById('vista-'+v).classList.remove('hidden');
    if(v==='historial') renderHistorial();
    if(v==='informe'){
        informeSeleccionado=null;
        renderInforme();
        document.querySelector('#vista-informe .no-print').style.display = eventos.length===0 ? 'none' : 'block';
    }
}

/* ‚îÄ‚îÄ edici√≥n ‚îÄ‚îÄ */
function editarInforme(id){
    var inf=buscarInforme(id);
    if(!inf){alert('No se encontr√≥ el informe');return;}
    document.getElementById('lider').value  = inf.infoGeneral.lider  || '';
    document.getElementById('semana').value = inf.infoGeneral.semana || '';
    document.getElementById('cuarto').value = inf.infoGeneral.cuarto || '';
    eventos = JSON.parse(JSON.stringify(inf.eventos));
    modoEdicion=true; idInformeEditando=id;
    document.getElementById('edit-banner').classList.remove('hidden');
    document.getElementById('edit-banner-nombre').textContent = nombreInforme(inf.infoGeneral);
    renderEventos();
    mostrarVista('registro');
}

function guardarEdicion(){
    if(eventos.length===0){alert('Agrega al menos un evento');return;}
    if(!eventos.some(function(e){return calcularTotal(e.gastos)>0;})){alert('Ingresa al menos un gasto');return;}
    var lider=document.getElementById('lider').value.trim();
    var semana=document.getElementById('semana').value.trim();
    if(!lider||!semana){alert('Completa el nombre del l\u00edder y la semana');return;}
    var tv=0,tg=0;
    for(var i=0;i<eventos.length;i++){
        tv+=(parseFloat(eventos[i].viaticosAsignados)||0);
        tg+=calcularTotal(eventos[i].gastos);
    }
    var idx=-1;
    for(var j=0;j<informesGuardados.length;j++){
        if(informesGuardados[j].id===idInformeEditando){idx=j;break;}
    }
    if(idx===-1){alert('Error: informe no encontrado');return;}
    informesGuardados[idx].infoGeneral = {lider:lider, semana:semana, cuarto:document.getElementById('cuarto').value.trim()};
    informesGuardados[idx].eventos     = JSON.parse(JSON.stringify(eventos));
    informesGuardados[idx].totalViaticosAsignados = tv;
    informesGuardados[idx].totalGastado           = tg;
    informesGuardados[idx].diferencia             = tv-tg;
    cancelarEdicion();
    actualizarContadorHistorial();
    alert('Liquidaci\u00f3n actualizada correctamente');
    mostrarVista('historial');
}

function cancelarEdicion(){
    modoEdicion=false; idInformeEditando=null;
    document.getElementById('edit-banner').classList.add('hidden');
    limpiarFormulario();
}

/* ‚îÄ‚îÄ eventos ‚îÄ‚îÄ */
function agregarEvento(){
    var ev={id:Date.now(),nombre:'',vehiculos:'',viaticosAsignados:0,gastos:{}};
    for(var i=0;i<CATEGORIAS.length;i++) ev.gastos[CATEGORIAS[i]]=0;
    eventos.push(ev);
    renderEventos();
    setTimeout(function(){
        var cards=document.querySelectorAll('.evento-card');
        if(cards.length) cards[cards.length-1].scrollIntoView({behavior:'smooth',block:'start'});
    },50);
}

function eliminarEvento(id){
    if(!confirm('Eliminar este evento?')) return;
    var arr=[];
    for(var i=0;i<eventos.length;i++) if(eventos[i].id!==id) arr.push(eventos[i]);
    eventos=arr; renderEventos();
}

function actualizarEvento(id,campo,valor){
    for(var i=0;i<eventos.length;i++){
        if(eventos[i].id===id){eventos[i][campo]=valor;calcularTotales();break;}
    }
}

function actualizarGasto(id,cat,valor){
    for(var i=0;i<eventos.length;i++){
        if(eventos[i].id===id){eventos[i].gastos[cat]=parseFloat(valor)||0;renderEventos();break;}
    }
}

function calcularTotales(){
    var tv=0,tg=0;
    for(var i=0;i<eventos.length;i++){
        tv+=(parseFloat(eventos[i].viaticosAsignados)||0);
        tg+=calcularTotal(eventos[i].gastos);
    }
    var df=tv-tg;
    document.getElementById('total-viaticos-asignados').textContent=fmt(tv);
    document.getElementById('total-gastado').textContent=fmt(tg);
    document.getElementById('diferencia-total').textContent=fmt(Math.abs(df));
    document.getElementById('diferencia-label').textContent=df>=0?'Saldo':'D\u00e9ficit';
    document.getElementById('diferencia-card').classList.toggle('deficit',df<0);
}

function renderEventos(){
    var cont=document.getElementById('eventos-container');
    if(eventos.length===0){
        cont.innerHTML='';
        document.getElementById('resumen-semanal').classList.add('hidden');
        return;
    }
    document.getElementById('resumen-semanal').classList.remove('hidden');
    var html='';
    for(var idx=0;idx<eventos.length;idx++){
        var ev=eventos[idx];
        var tg=calcularTotal(ev.gastos);
        var iva=calcularIVADesglosado(ev.gastos);
        var vi=parseFloat(ev.viaticosAsignados)||0;
        var df=vi-tg;
        var ivaRow = iva>0
            ? '<div class="resumen-item"><span style="color:#6b7280;">IVA incluido (Hotel/Gasolina):</span><strong>'+fmt(iva)+'</strong></div>'
            : '';
        var dfColor=df>=0?'#16a34a':'#dc2626';
        var dfLabel=df>=0?'Saldo:':'D\u00e9ficit:';
        var gastosCols='';
        for(var g=0;g<CATEGORIAS.length;g++){
            var cat=CATEGORIAS[g];
            var asterisco=CATS_IVA.indexOf(cat)>=0?' *':'';
            gastosCols+='<div class="form-group">'
                +'<label>'+cat+asterisco+'</label>'
                +'<input type="number" step="0.01" value="'+ev.gastos[cat]+'" '
                +'onchange="actualizarGasto('+ev.id+',\''+cat+'\',this.value)">'
                +'</div>';
        }
        html+='<div class="evento-card">'
            +'<div class="evento-header">'
            +'<h3>'+(ev.nombre||'Evento '+(idx+1))+'</h3>'
            +'<button class="btn btn-danger btn-icon" onclick="eliminarEvento('+ev.id+')" title="Eliminar">&#x1F5D1;</button>'
            +'</div>'
            +'<div class="form-grid">'
            +'<div class="form-group"><label>Nombre del Evento</label>'
            +'<input type="text" value="'+ev.nombre+'" placeholder="Nombre del evento" '
            +'onchange="actualizarEvento('+ev.id+',\'nombre\',this.value)"></div>'
            +'<div class="form-group"><label>Veh\u00edculos Utilizados</label>'
            +'<input type="text" value="'+ev.vehiculos+'" placeholder="Ej: Toyota Corolla ABC-123" '
            +'onchange="actualizarEvento('+ev.id+',\'vehiculos\',this.value)"></div>'
            +'<div class="form-group"><label>Vi\u00e1ticos Asignados ($)</label>'
            +'<input type="number" step="0.01" value="'+ev.viaticosAsignados+'" '
            +'onchange="actualizarEvento('+ev.id+',\'viaticosAsignados\',this.value)"></div>'
            +'</div>'
            +'<div style="border-top:1px solid #e5e7eb;margin-top:14px;padding-top:14px;">'
            +'<h4 style="margin-bottom:3px;">Gastos por Categor\u00eda</h4>'
            +'<p class="iva-nota">* Hotel y Gasolina: ingrese monto total (IVA ya incluido)</p>'
            +'<div class="gastos-grid">'+gastosCols+'</div>'
            +'<div class="resumen-box">'
            +ivaRow
            +'<div class="resumen-item"><span style="color:#1f2937;font-weight:600;">Total Gastado:</span><strong style="color:#2563eb;">'+fmt(tg)+'</strong></div>'
            +'<div class="resumen-item total"><span>Vi\u00e1ticos Asignados:</span><strong>'+fmt(vi)+'</strong></div>'
            +'<div class="resumen-item" style="color:'+dfColor+';">'
            +'<span style="font-weight:bold;">'+dfLabel+'</span><strong>'+fmt(Math.abs(df))+'</strong></div>'
            +'</div></div></div>';
    }
    cont.innerHTML=html;
    calcularTotales();
}

/* ‚îÄ‚îÄ guardar nuevo ‚îÄ‚îÄ */
function guardarInforme(){
    if(modoEdicion){guardarEdicion();return;}
    if(eventos.length===0){alert('Agrega al menos un evento');return;}
    if(!eventos.some(function(e){return calcularTotal(e.gastos)>0;})){alert('Ingresa al menos un gasto');return;}
    var lider=document.getElementById('lider').value.trim();
    var semana=document.getElementById('semana').value.trim();
    if(!lider||!semana){alert('Completa el nombre del l\u00edder y la semana');return;}
    var tv=0,tg=0;
    for(var i=0;i<eventos.length;i++){
        tv+=(parseFloat(eventos[i].viaticosAsignados)||0);
        tg+=calcularTotal(eventos[i].gastos);
    }
    var inf={
        id:Date.now(),
        fecha:new Date().toISOString(),
        infoGeneral:{lider:lider,semana:semana,cuarto:document.getElementById('cuarto').value.trim()},
        eventos:JSON.parse(JSON.stringify(eventos)),
        totalViaticosAsignados:tv,
        totalGastado:tg,
        diferencia:tv-tg
    };
    informesGuardados.unshift(inf);
    actualizarContadorHistorial();
    limpiarFormulario();
    alert('Informe guardado. Total: '+informesGuardados.length);
    mostrarVista('historial');
}

function limpiarFormulario(){
    ['lider','semana','cuarto'].forEach(function(id){document.getElementById(id).value='';});
    eventos=[]; renderEventos();
}

function actualizarContadorHistorial(){
    document.getElementById('historial-count').textContent=informesGuardados.length;
}

/* ‚îÄ‚îÄ historial ‚îÄ‚îÄ */
function buscarInforme(id){
    for(var i=0;i<informesGuardados.length;i++) if(informesGuardados[i].id===id) return informesGuardados[i];
    return null;
}

function eliminarInformeGuardado(id){
    if(!confirm('Eliminar este informe permanentemente?')) return;
    var arr=[];
    for(var i=0;i<informesGuardados.length;i++) if(informesGuardados[i].id!==id) arr.push(informesGuardados[i]);
    informesGuardados=arr;
    actualizarContadorHistorial();
    renderHistorial();
}

function verInformeGuardado(id){
    informeSeleccionado=buscarInforme(id);
    if(!informeSeleccionado){alert('No se pudo cargar');return;}
    ['registro','historial'].forEach(function(x){document.getElementById('vista-'+x).classList.add('hidden');});
    document.getElementById('vista-informe').classList.remove('hidden');
    renderInforme();
    document.querySelector('#vista-informe .no-print').style.display='block';
}

function renderHistorial(){
    var cont=document.getElementById('historial-container');
    if(informesGuardados.length===0){
        cont.innerHTML='<div class="empty-state"><div class="empty-state-icon">üì¶</div>'
            +'<p style="font-size:18px;margin-bottom:8px;">No hay informes guardados</p>'
            +'<p>Crea tu primer informe en la pesta\u00f1a Registro</p></div>';
        return;
    }
    var html='<div class="historial-grid">';
    for(var i=0;i<informesGuardados.length;i++){
        var inf=informesGuardados[i];
        var dfColor=inf.diferencia>=0?'#16a34a':'#dc2626';
        var dfLabel=inf.diferencia>=0?'Saldo:':'D\u00e9ficit:';
        var fecha=new Date(inf.fecha).toLocaleDateString('es-ES',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
        html+='<div class="historial-card">'
            +'<div class="historial-header">'
            +'<div class="historial-header-title">'
            +'<h3>'+nombreInforme(inf.infoGeneral)+'</h3>'
            +'<p>'+fecha+'</p>'
            +'</div>'
            +'<button class="btn btn-danger btn-icon" onclick="eliminarInformeGuardado('+inf.id+')" title="Eliminar">&#x2715;</button>'
            +'</div>'
            +'<div style="border-top:1px solid #e5e7eb;padding-top:12px;">'
            +'<p class="historial-info"><strong>L\u00edder:</strong> '+(inf.infoGeneral.lider||'N/A')+'</p>'
            +'<p class="historial-info"><strong>Eventos:</strong> '+inf.eventos.length+'</p>'
            +'<p class="historial-info"><strong>Vi\u00e1ticos:</strong> '+fmt(inf.totalViaticosAsignados)+'</p>'
            +'<p class="historial-info"><strong>Gastado:</strong> '+fmt(inf.totalGastado)+'</p>'
            +'<p class="historial-info" style="color:'+dfColor+';font-weight:600;"><strong>'+dfLabel+'</strong> '+fmt(Math.abs(inf.diferencia))+'</p>'
            +'</div>'
            +'<div class="historial-actions">'
            +'<button class="btn btn-primary" onclick="verInformeGuardado('+inf.id+')">&#x1F441;&#xFE0F; Ver</button>'
            +'<button class="btn btn-warning" onclick="editarInforme('+inf.id+')">&#x270F;&#xFE0F; Editar</button>'
            +'</div></div>';
    }
    html+='</div>';
    cont.innerHTML=html;
}

/* ‚îÄ‚îÄ informe ‚îÄ‚îÄ */
function renderInforme(){
    var d;
    if(informeSeleccionado){
        d=informeSeleccionado;
    } else {
        var tv=0,tg=0;
        for(var i=0;i<eventos.length;i++){
            tv+=(parseFloat(eventos[i].viaticosAsignados)||0);
            tg+=calcularTotal(eventos[i].gastos);
        }
        d={
            infoGeneral:{
                lider:document.getElementById('lider').value,
                semana:document.getElementById('semana').value,
                cuarto:document.getElementById('cuarto').value
            },
            eventos:eventos,
            totalViaticosAsignados:tv,
            totalGastado:tg,
            diferencia:tv-tg
        };
    }
    if(!d.eventos||d.eventos.length===0){
        document.getElementById('informe-content').innerHTML='<div class="empty-state"><div class="empty-state-icon">üìÑ</div>'
            +'<p style="font-size:18px;margin-bottom:8px;">No hay eventos para generar informe</p>'
            +'<p>Agrega eventos en la pesta\u00f1a Registro</p></div>';
        return;
    }

    /* consolidado */
    var con={};
    for(var ci=0;ci<CATEGORIAS.length;ci++){
        var cat=CATEGORIAS[ci];
        var tot=0;
        for(var ei=0;ei<d.eventos.length;ei++) tot+=(d.eventos[ei].gastos[cat]||0);
        var base=tot, iva=0;
        if(CATS_IVA.indexOf(cat)>=0){ var r=extraerIVA(tot); base=r.base; iva=r.iva; }
        con[cat]={tot:tot,base:base,iva:iva};
    }

    /* filas tabla */
    var filas='', totalGeneral=0, totalViaticosTodos=0, filaIdx=0;
    for(var ei2=0;ei2<d.eventos.length;ei2++){
        var ev=d.eventos[ei2];
        var vi=parseFloat(ev.viaticosAsignados)||0;
        var totalEv=calcularTotal(ev.gastos);
        var df=vi-totalEv;
        totalGeneral+=totalEv; totalViaticosTodos+=vi;
        var vehicStr=ev.vehiculos ? ' \u2014 \uD83D\uDE97 '+ev.vehiculos : '';
        var evNombre=ev.nombre||('Evento '+(ei2+1));
        filas+='<tr class="ev-header">'
            +'<td colspan="5">'+evNombre+vehicStr+'</td>'
            +'<td style="text-align:right;">Vi\u00e1ticos: '+fmt(vi)+'</td>'
            +'</tr>';
        for(var gi=0;gi<CATEGORIAS.length;gi++){
            var gcat=CATEGORIAS[gi];
            var m=ev.gastos[gcat]||0;
            if(m===0) continue;
            var hayIVA=CATS_IVA.indexOf(gcat)>=0;
            var gbase=m, giva=0;
            if(hayIVA){ var gr=extraerIVA(m); gbase=gr.base; giva=gr.iva; }
            var parClass=filaIdx%2===1?'fila-par':'';
            filaIdx++;
            filas+='<tr class="'+parClass+'">'
                +'<td style="padding-left:14px;">'+gcat+'</td>'
                +'<td style="text-align:right;">'+(hayIVA?fmt(gbase):'-')+'</td>'
                +'<td style="text-align:right;">'+(hayIVA?fmt(giva):'-')+'</td>'
                +'<td style="text-align:right;font-weight:bold;">'+fmt(m)+'</td>'
                +'<td></td><td></td>'
                +'</tr>';
        }
        var dfColor2=df>=0?'#16a34a':'#dc2626';
        var dfLabel2=df>=0?'Saldo:':'D\u00e9ficit:';
        filas+='<tr class="ev-subtotal">'
            +'<td colspan="3" style="text-align:right;">Subtotal evento:</td>'
            +'<td style="text-align:right;">'+fmt(totalEv)+'</td>'
            +'<td colspan="2" style="text-align:right;color:'+dfColor2+';">'+dfLabel2+' '+fmt(Math.abs(df))+'</td>'
            +'</tr>';
    }
    var dfTotal=totalViaticosTodos-totalGeneral;
    var dfTotalLabel=dfTotal>=0?'Saldo:':'D\u00e9ficit:';

    /* consolidado HTML (solo pantalla) */
    var conHtml='';
    for(var cj=0;cj<CATEGORIAS.length;cj++){
        var ccat=CATEGORIAS[cj];
        if(con[ccat].tot===0) continue;
        var ivaStr=con[ccat].iva>0?'<div class="civa">IVA: '+fmt(con[ccat].iva)+'</div>':'';
        conHtml+='<div class="rpt-con-item">'
            +'<div class="clabel">'+ccat+'</div>'
            +'<div class="cval">'+fmt(con[ccat].tot)+'</div>'
            +ivaStr
            +'</div>';
    }

    var hoy=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'});
    var dfResColor=d.diferencia>=0?'#16a34a':'#dc2626';
    var dfResLabel=d.diferencia>=0?'Saldo':'Sobregiro';

    document.getElementById('informe-content').innerHTML=
        '<div class="rpt-wrap">'
        +'<div class="rpt-header">'
        +'<div>'
        +'<div class="rpt-title">RGIS El Salvador &mdash; Distrito 647</div>'
        +'<div class="rpt-sub">Liquidaci\u00f3n de Vi\u00e1ticos Semanal &bull; '+nombreInforme(d.infoGeneral)+'</div>'
        +'</div>'
        +'<div class="rpt-meta">'
        +'<div class="rpt-meta-item"><p>L\u00edder</p><p>'+(d.infoGeneral.lider||'N/A')+'</p></div>'
        +'<div class="rpt-meta-item"><p>Semana</p><p>'+(d.infoGeneral.semana||'N/A')+'</p></div>'
        +'<div class="rpt-meta-item"><p>Cuarto</p><p>'+(d.infoGeneral.cuarto||'N/A')+'</p></div>'
        +'<div class="rpt-meta-item"><p>Fecha</p><p>'+hoy+'</p></div>'
        +'</div>'
        +'</div>'
        +'<div class="rpt-resumen">'
        +'<div class="rpt-res-item"><div class="rlabel">Vi\u00e1ticos Asignados</div><div class="rval">'+fmt(d.totalViaticosAsignados)+'</div></div>'
        +'<div class="rpt-res-item"><div class="rlabel">Total Gastado</div><div class="rval" style="color:#2563eb;">'+fmt(d.totalGastado)+'</div></div>'
        +'<div class="rpt-res-item" style="'+(d.diferencia<0?'border-color:#dc2626;':'')+'">'
        +'<div class="rlabel">'+dfResLabel+'</div>'
        +'<div class="rval" style="color:'+dfResColor+';">'+fmt(Math.abs(d.diferencia))+'</div>'
        +'</div>'
        +'</div>'
        +'<table class="rpt-table">'
        +'<thead><tr>'
        +'<th style="width:30%;">Categor\u00eda / Evento</th>'
        +'<th style="text-align:right;width:14%;">Base (sin IVA)</th>'
        +'<th style="text-align:right;width:14%;">IVA 13% (incl.)</th>'
        +'<th style="text-align:right;width:14%;">Total</th>'
        +'<th style="width:14%;"></th>'
        +'<th style="text-align:right;width:14%;"></th>'
        +'</tr></thead>'
        +'<tbody>'+filas
        +'<tr class="grand-total">'
        +'<td colspan="3">TOTAL GENERAL</td>'
        +'<td style="text-align:right;">'+fmt(totalGeneral)+'</td>'
        +'<td colspan="2" style="text-align:right;">'+dfTotalLabel+' '+fmt(Math.abs(dfTotal))+'</td>'
        +'</tr>'
        +'</tbody>'
        +'</table>'
        +'<div class="rpt-consolidado no-print">'
        +'<div class="rpt-consolidado-title">Consolidado por Categor\u00eda</div>'
        +'<div class="rpt-consolidado-grid">'+conHtml+'</div>'
        +'</div>'
        +'<div class="rpt-firmas" style="grid-template-columns:1fr;">'
        +'<div class="rpt-firma"><div class="rpt-firma-line"></div>'        +'<p><strong>'+(d.infoGeneral.lider||'L\u00edder Responsable')+'</strong></p>'
        +'<p>Elaborado por</p></div>'
        +'</div>'
        +'</div>';
}

/* ‚îÄ‚îÄ imprimir ‚îÄ‚îÄ */
function imprimirInforme(){
    var d=informeSeleccionado||{
        infoGeneral:{
            lider:document.getElementById('lider').value,
            semana:document.getElementById('semana').value,
            cuarto:document.getElementById('cuarto').value
        }
    };
    var lider=(d.infoGeneral.lider||'Lider').trim();
    var semana=(d.infoGeneral.semana||'?').trim();
    var cuarto=(d.infoGeneral.cuarto||'?').trim();
    var titulo=lider+' - Liquidaci\u00f3n Semana '+semana+' Cuarto '+cuarto;
    var prev=document.title;
    document.title=titulo;
    window.print();
    document.title=prev;
}

mostrarVista('registro');
</script>
</body>
</html>
